{% extends 'base.html' %}

{% block title %}Social Media Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">Social Media Dashboard</h1>
            <div>
                <a href="{{ url_for('social.social_accounts') }}" class="btn btn-primary">
                    <i class="fas fa-users-cog me-1"></i> Manage Accounts
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Stats cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-0 bg-primary text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="rounded-circle bg-primary p-3 me-3">
                        <i class="fab fa-facebook-f text-white"></i>
                    </div>
                    <div>
                        <h5 class="card-title text-black fw-bold">Facebook</h5>
                        <h6 class="mb-0 text-black">{{ platform_stats.facebook.published }} / {{ platform_stats.facebook.total }}</h6>
                    </div>
                </div>
                <div class="progress mt-3" style="height: 6px;">
                    <div class="progress-bar bg-primary" role="progressbar" 
                        style="width: {{ (platform_stats.facebook.published / platform_stats.facebook.total * 100) if platform_stats.facebook.total > 0 else 0 }}%;" 
                        aria-valuenow="{{ platform_stats.facebook.published }}" 
                        aria-valuemin="0" 
                        aria-valuemax="{{ platform_stats.facebook.total }}">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 bg-info text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="rounded-circle bg-info p-3 me-3">
                        <i class="fab fa-twitter text-white"></i>
                    </div>
                    <div>
                        <h5 class="card-title text-black fw-bold">Twitter</h5>
                        <h6 class="mb-0 text-black">{{ platform_stats.twitter.published }} / {{ platform_stats.twitter.total }}</h6>
                    </div>
                </div>
                <div class="progress mt-3" style="height: 6px;">
                    <div class="progress-bar bg-info" role="progressbar" 
                        style="width: {{ (platform_stats.twitter.published / platform_stats.twitter.total * 100) if platform_stats.twitter.total > 0 else 0 }}%;" 
                        aria-valuenow="{{ platform_stats.twitter.published }}" 
                        aria-valuemin="0" 
                        aria-valuemax="{{ platform_stats.twitter.total }}">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 bg-success text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="rounded-circle bg-success p-3 me-3">
                        <i class="fab fa-linkedin-in text-white"></i>
                    </div>
                    <div>
                        <h5 class="card-title text-black fw-bold">LinkedIn</h5>
                        <h6 class="mb-0 text-black">{{ platform_stats.linkedin.published }} / {{ platform_stats.linkedin.total }}</h6>
                    </div>
                </div>
                <div class="progress mt-3" style="height: 6px;">
                    <div class="progress-bar bg-success" role="progressbar" 
                        style="width: {{ (platform_stats.linkedin.published / platform_stats.linkedin.total * 100) if platform_stats.linkedin.total > 0 else 0 }}%;" 
                        aria-valuenow="{{ platform_stats.linkedin.published }}" 
                        aria-valuemin="0" 
                        aria-valuemax="{{ platform_stats.linkedin.total }}">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 bg-danger text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="rounded-circle bg-danger p-3 me-3">
                        <i class="fab fa-instagram text-white"></i>
                    </div>
                    <div>
                        <h5 class="card-title text-black fw-bold">Instagram</h5>
                        <h6 class="mb-0 text-black">{{ platform_stats.instagram.published }} / {{ platform_stats.instagram.total }}</h6>
                    </div>
                </div>
                <div class="progress mt-3" style="height: 6px;">
                    <div class="progress-bar bg-danger" role="progressbar" 
                        style="width: {{ (platform_stats.instagram.published / platform_stats.instagram.total * 100) if platform_stats.instagram.total > 0 else 0 }}%;" 
                        aria-valuenow="{{ platform_stats.instagram.published }}" 
                        aria-valuemin="0" 
                        aria-valuemax="{{ platform_stats.instagram.total }}">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filter by blog -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0 fw-bold">Filter Content</h5>
    </div>
    <div class="card-body">
        <form action="{{ url_for('social.social_dashboard') }}" method="get" class="row g-3">
            <div class="col-md-6">
                <label for="blog_id" class="form-label">Select Blog</label>
                <select name="blog_id" id="blog_id" class="form-select">
                    <option value="">All Blogs</option>
                    {% for blog in blogs %}
                    <option value="{{ blog.id }}" {% if selected_blog_id == blog.id %}selected{% endif %}>
                        {{ blog.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6 d-flex align-items-end">
                <button type="submit" class="btn btn-primary">Apply Filter</button>
            </div>
        </form>
    </div>
</div>

<!-- Social media posts table -->
<div class="card">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0 fw-bold">Recent Social Media Posts</h5>
    </div>
    <div class="card-body p-0">
        {% if social_data %}
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Article Title</th>
                        <th>Blog</th>
                        <th>Platforms</th>
                        <th>Created</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in social_data %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="ms-2">
                                    <h6 class="mb-0">{{ item.title }}</h6>
                                    {% if item.url %}
                                    <a href="{{ item.url }}" target="_blank" class="text-muted small">
                                        <i class="fas fa-external-link-alt me-1"></i>View Article
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td>{{ item.blog_name }}</td>
                        <td>
                            <div class="d-flex">
                                {% if 'facebook' in item.social_posts %}
                                <div class="platform-icon me-2" data-bs-toggle="tooltip" title="Facebook">
                                    <i class="fab fa-facebook-f text-primary"></i>
                                </div>
                                {% endif %}
                                {% if 'twitter' in item.social_posts %}
                                <div class="platform-icon me-2" data-bs-toggle="tooltip" title="Twitter">
                                    <i class="fab fa-twitter text-info"></i>
                                </div>
                                {% endif %}
                                {% if 'linkedin' in item.social_posts %}
                                <div class="platform-icon me-2" data-bs-toggle="tooltip" title="LinkedIn">
                                    <i class="fab fa-linkedin-in text-success"></i>
                                </div>
                                {% endif %}
                                {% if 'instagram' in item.social_posts %}
                                <div class="platform-icon me-2" data-bs-toggle="tooltip" title="Instagram">
                                    <i class="fab fa-instagram text-danger"></i>
                                </div>
                                {% endif %}
                            </div>
                        </td>
                        <td>{{ item.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            <div id="status-{{ item.content_id }}">
                                {% set all_published = true %}
                                {% set has_error = false %}
                                {% set has_pending = false %}
                                {% for platform, post in item.social_posts.items() %}
                                    {% if post.get('status') != 'published' %}
                                        {% set all_published = false %}
                                    {% endif %}
                                    {% if post.get('status') == 'error' %}
                                        {% set has_error = true %}
                                    {% endif %}
                                    {% if post.get('status') == 'pending' %}
                                        {% set has_pending = true %}
                                    {% endif %}
                                {% endfor %}
                                
                                {% if all_published %}
                                    <span class="badge bg-success">Published</span>
                                {% elif has_error %}
                                    <span class="badge bg-danger">Error</span>
                                {% elif has_pending %}
                                    <span class="badge bg-warning">Scheduled</span>
                                {% else %}
                                    <span class="badge bg-secondary">Draft</span>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <div class="btn-group">
                                <a href="{{ url_for('social.preview_posts', content_id=item.content_id) }}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye me-1"></i>Preview
                                </a>
                                <button type="button" class="btn btn-sm btn-outline-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                                    <span class="visually-hidden">Toggle Dropdown</span>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    {% for platform, post in item.social_posts.items() %}
                                    <li>
                                        <a class="dropdown-item" href="{{ url_for('social.edit_post', content_id=item.content_id, platform=platform) }}">
                                            <i class="fab fa-{{ platform.lower() }} me-1"></i>Edit {{ platform|capitalize }}
                                        </a>
                                    </li>
                                    {% endfor %}
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <a class="dropdown-item text-success" href="#" data-bs-toggle="modal" data-bs-target="#publishModal" data-content-id="{{ item.content_id }}">
                                            <i class="fas fa-paper-plane me-1"></i>Publish Now
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center p-5">
            <div class="mb-3">
                <i class="fas fa-share-alt fa-4x text-muted"></i>
            </div>
            <h5>No Social Media Posts Found</h5>
            <p class="text-muted">No social media posts have been created yet.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Publish Modal -->
<div class="modal fade" id="publishModal" tabindex="-1" aria-labelledby="publishModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="publishModalLabel">Publish Social Media Posts</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="publishForm" action="" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Select Platforms to Publish</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="facebook" name="platforms" id="platform-facebook">
                            <label class="form-check-label" for="platform-facebook">
                                <i class="fab fa-facebook-f text-primary me-1"></i> Facebook
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="twitter" name="platforms" id="platform-twitter">
                            <label class="form-check-label" for="platform-twitter">
                                <i class="fab fa-twitter text-info me-1"></i> Twitter
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="linkedin" name="platforms" id="platform-linkedin">
                            <label class="form-check-label" for="platform-linkedin">
                                <i class="fab fa-linkedin-in text-success me-1"></i> LinkedIn
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="instagram" name="platforms" id="platform-instagram">
                            <label class="form-check-label" for="platform-instagram">
                                <i class="fab fa-instagram text-danger me-1"></i> Instagram
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="scheduleSwitch">
                            <label class="form-check-label" for="scheduleSwitch">Schedule for later</label>
                        </div>
                    </div>
                    <div class="mb-3 d-none" id="scheduleTimeField">
                        <label for="scheduled_time" class="form-label">Schedule Time</label>
                        <input type="datetime-local" class="form-control" id="scheduled_time" name="scheduled_time">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Publish</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle publish modal
        const publishModal = document.getElementById('publishModal');
        if (publishModal) {
            publishModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const contentId = button.getAttribute('data-content-id');
                const form = document.getElementById('publishForm');
                form.action = `/social/posts/${contentId}/publish`;
            });
        }
        
        // Handle schedule switch
        const scheduleSwitch = document.getElementById('scheduleSwitch');
        const scheduleTimeField = document.getElementById('scheduleTimeField');
        
        if (scheduleSwitch && scheduleTimeField) {
            scheduleSwitch.addEventListener('change', function() {
                if (this.checked) {
                    scheduleTimeField.classList.remove('d-none');
                } else {
                    scheduleTimeField.classList.add('d-none');
                }
            });
        }
        
        // Status polling for pending posts
        function pollPostStatus() {
            document.querySelectorAll('[id^="status-"]').forEach(function(element) {
                const contentId = element.id.split('-')[1];
                
                fetch(`/api/social/posts/${contentId}/status`)
                    .then(response => response.json())
                    .then(data => {
                        // Check if any posts are pending or error
                        const hasError = Object.values(data).some(post => post.status === 'error');
                        const hasPending = Object.values(data).some(post => post.status === 'pending');
                        const allPublished = Object.values(data).every(post => post.status === 'published');
                        
                        let statusHtml = '';
                        if (hasError) {
                            statusHtml = '<span class="badge bg-danger">Error</span>';
                        } else if (hasPending) {
                            statusHtml = '<span class="badge bg-warning">Scheduled</span>';
                        } else if (allPublished) {
                            statusHtml = '<span class="badge bg-success">Published</span>';
                        } else {
                            statusHtml = '<span class="badge bg-secondary">Draft</span>';
                        }
                        
                        element.innerHTML = statusHtml;
                    });
            });
        }
        
        // Poll every 30 seconds
        setInterval(pollPostStatus, 30000);
    });
</script>
{% endblock %}