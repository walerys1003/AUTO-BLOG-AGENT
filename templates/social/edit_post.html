{% extends 'base.html' %}

{% block title %}Edit {{ platform|capitalize }} Post{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <a href="{{ url_for('social.preview_posts', content_id=content.id) }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Back to Preview
        </a>
    </div>
    <h1 class="h3 mb-0">Edit {{ platform|capitalize }} Post</h1>
    <div>
        <form action="{{ url_for('social.regenerate_post', content_id=content.id, platform=platform) }}" method="post">
            <button type="submit" class="btn btn-outline-primary">
                <i class="fas fa-sync-alt me-1"></i> Regenerate
            </button>
        </form>
    </div>
</div>

<div class="row">
    <div class="col-md-7">
        <div class="card mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0">Edit Post Content</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('social.edit_post', content_id=content.id, platform=platform) }}" method="post">
                    <div class="mb-3">
                        <label for="content" class="form-label">Content</label>
                        <textarea class="form-control" id="content" name="content" rows="6" required>{{ post_data.content }}</textarea>
                        {% if platform == 'twitter' %}
                        <div class="form-text">
                            <span id="char-count">0</span>/280 characters
                        </div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="hashtags" class="form-label">Hashtags</label>
                        <input type="text" class="form-control" id="hashtags" name="hashtags" value="{{ post_data.hashtags|join(', ') }}">
                        <div class="form-text">Separate hashtags with commas</div>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-5">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="fab fa-{{ platform.lower() }} me-2 text-{{ platform_color }}"></i>
                    {{ platform|capitalize }} Preview
                </h5>
            </div>
            <div class="card-body">
                <div class="social-preview {{ platform.lower() }}-preview">
                    <div class="social-header d-flex align-items-center mb-2">
                        <div class="profile-img me-2">
                            <img src="{{ url_for('static', filename='img/default-profile.png') }}" alt="Profile" class="rounded-circle" width="40" height="40">
                        </div>
                        <div>
                            <div class="fw-bold">{{ content.blog.name if content.blog else 'Blog Name' }}</div>
                            {% if platform == 'twitter' %}
                            <div class="text-muted small">@{{ content.blog.name|lower|replace(' ', '') if content.blog else 'blogname' }}</div>
                            {% else %}
                            <div class="text-muted small">Just now</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="social-content mb-2">
                        <span id="preview-content">{{ post_data.content }}</span>
                    </div>
                    <div class="social-hashtags mb-2">
                        <span id="preview-hashtags">
                            {% for tag in post_data.hashtags %}
                            <span class="text-{{ platform_color }}">#{{ tag }}</span>
                            {% endfor %}
                        </span>
                    </div>
                    {% if content.featured_image_data %}
                    <div class="social-image mb-2">
                        <img src="{{ content.get_featured_image().url }}" alt="{{ content.title }}" class="img-fluid rounded">
                        {% if platform == 'linkedin' %}
                        <div class="card mt-1">
                            <div class="card-body p-2">
                                <div class="small fw-bold">{{ content.title }}</div>
                                <div class="small text-muted">{{ content.excerpt | truncate(100) }}</div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    {% if platform == 'facebook' %}
                    <div class="social-url bg-light p-2 rounded mt-2">
                        <a href="{{ content.url or '#' }}" class="text-decoration-none" target="_blank">
                            <div class="small text-truncate">{{ content.url or 'https://blog.example.com' }}</div>
                            <div class="fw-bold">{{ content.title }}</div>
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="card-footer bg-white">
                <div class="text-muted small">
                    <strong>Article:</strong> <a href="{{ content.url }}" target="_blank" class="text-primary">{{ content.title }}</a>
                </div>
                {% if post_data.status == 'published' %}
                <div class="mt-2">
                    <span class="badge bg-success">Published</span>
                    {% if post_data.post_url %}
                    <a href="{{ post_data.post_url }}" target="_blank" class="text-{{ platform_color }} ms-2">
                        <i class="fas fa-external-link-alt me-1"></i>View Post
                    </a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const contentTextarea = document.getElementById('content');
        const previewContent = document.getElementById('preview-content');
        const hashtagsInput = document.getElementById('hashtags');
        const previewHashtags = document.getElementById('preview-hashtags');
        const charCount = document.getElementById('char-count');
        
        // Platform-specific colors
        const platformColor = '{{ platform_color }}';
        
        // Update preview on content change
        if (contentTextarea && previewContent) {
            contentTextarea.addEventListener('input', function() {
                previewContent.textContent = this.value;
                
                // Update character count for Twitter
                if (charCount) {
                    charCount.textContent = this.value.length;
                    
                    if (this.value.length > 280) {
                        charCount.classList.add('text-danger');
                    } else {
                        charCount.classList.remove('text-danger');
                    }
                }
            });
        }
        
        // Update hashtags preview on change
        if (hashtagsInput && previewHashtags) {
            hashtagsInput.addEventListener('input', function() {
                const hashtags = this.value.split(',').map(tag => tag.trim()).filter(tag => tag);
                
                let hashtagsHtml = '';
                hashtags.forEach(tag => {
                    hashtagsHtml += `<span class="text-${platformColor}">#${tag}</span> `;
                });
                
                previewHashtags.innerHTML = hashtagsHtml;
            });
        }
    });
</script>
{% endblock %}