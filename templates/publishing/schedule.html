{% extends "base.html" %}

{% block title %}Publication Schedule - BLOG AUTOMATION MASTER{% endblock %}

{% block styles %}
<!-- FullCalendar CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css">
<style>
    .fc-event {
        cursor: pointer;
    }
    .automation-status {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
    }
</style>
{% endblock %}

{% block content %}
<section class="container">
    <div class="row mb-4 align-items-center">
        <div class="col">
            <h1 class="h2 mb-1">Publication Schedule</h1>
            <p class="text-muted">Calendar view of scheduled content publications</p>
        </div>
        <div class="col-auto">
            <form id="blog-filter-form" class="row g-3">
                <div class="col-auto">
                    <select name="blog_id" id="blog-filter" class="form-select" onchange="this.form.submit()">
                        <option value="">All Blogs</option>
                        {% for blog in blogs %}
                        <option value="{{ blog.id }}" {% if selected_blog_id == blog.id %}selected{% endif %}>{{ blog.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </form>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('publishing.publishing_dashboard') }}" class="btn btn-outline-secondary">
                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
            </a>
            <a href="{{ url_for('publishing.pending_articles') }}" class="btn btn-outline-primary ms-2">
                <i class="fas fa-list-ul me-2"></i>Pending Articles
            </a>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body position-relative">
                    <!-- Automation Status -->
                    {% if selected_blog_id and selected_blog_id in automation_status %}
                    <div class="automation-status">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="automationToggle" 
                                {% if automation_status[selected_blog_id]['active'] %}checked{% endif %}
                                data-blog-id="{{ selected_blog_id }}">
                            <label class="form-check-label" for="automationToggle">
                                {% if automation_status[selected_blog_id]['active'] %}
                                <span class="text-success">Automation Active</span>
                                {% else %}
                                <span class="text-muted">Automation Paused</span>
                                {% endif %}
                            </label>
                        </div>
                        <small class="text-muted d-block">
                            {% if automation_status[selected_blog_id]['rule_count'] > 0 %}
                            {{ automation_status[selected_blog_id]['rule_count'] }} active rule(s)
                            {% else %}
                            No automation rules
                            {% endif %}
                        </small>
                    </div>
                    {% endif %}

                    <!-- Calendar Container -->
                    <div id="calendar"></div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Event Modal -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Publication Schedule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="event-form">
                    <input type="hidden" id="event-id">
                    <div class="mb-3">
                        <label for="event-title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="event-title" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="event-date" class="form-label">Date</label>
                        <input type="date" class="form-control" id="event-date">
                    </div>
                    <div class="mb-3">
                        <label for="event-time" class="form-label">Time</label>
                        <input type="time" class="form-control" id="event-time">
                    </div>
                    <div class="mb-3">
                        <label for="event-status" class="form-label">Status</label>
                        <input type="text" class="form-control" id="event-status" readonly>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-event">Save Changes</button>
                <a href="#" id="edit-content-link" class="btn btn-outline-secondary">
                    <i class="fas fa-edit me-1"></i> Edit Content
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        events: {{ calendar_events|safe }},
        eventClick: function(info) {
            showEventModal(info.event);
        }
    });
    calendar.render();
    
    // Event Modal
    function showEventModal(event) {
        document.getElementById('event-id').value = event.id;
        document.getElementById('event-title').value = event.title;
        
        // Parse date and time
        const startDate = new Date(event.start);
        document.getElementById('event-date').value = startDate.toISOString().split('T')[0];
        
        // Format time
        const hours = startDate.getHours().toString().padStart(2, '0');
        const minutes = startDate.getMinutes().toString().padStart(2, '0');
        document.getElementById('event-time').value = `${hours}:${minutes}`;
        
        // Status
        const status = event.extendedProps.status;
        const statusInput = document.getElementById('event-status');
        statusInput.value = status.charAt(0).toUpperCase() + status.slice(1);
        
        // Status color
        if (status === 'published') {
            statusInput.classList.remove('is-invalid', 'is-warning');
            statusInput.classList.add('is-valid');
        } else if (status === 'failed') {
            statusInput.classList.remove('is-valid', 'is-warning');
            statusInput.classList.add('is-invalid');
        } else {
            statusInput.classList.remove('is-valid', 'is-invalid');
        }
        
        // Edit content link
        document.getElementById('edit-content-link').href = "{{ url_for('publishing.edit_article', content_id=0) }}".replace('0', event.extendedProps.content_id);
        
        // Show modal
        const eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
        eventModal.show();
    }
    
    // Save Event Changes
    document.getElementById('save-event').addEventListener('click', function() {
        const eventId = document.getElementById('event-id').value;
        const eventDate = document.getElementById('event-date').value;
        const eventTime = document.getElementById('event-time').value;
        
        // Send update to server
        fetch("{{ url_for('publishing.update_schedule') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                id: eventId,
                date: eventDate,
                time: eventTime
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
                
                // Refresh page to show updated event
                window.location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating the schedule.');
        });
    });
    
    // Automation Toggle
    const automationToggle = document.getElementById('automationToggle');
    if (automationToggle) {
        automationToggle.addEventListener('change', function() {
            const blogId = this.getAttribute('data-blog-id');
            const status = this.checked;
            
            // Send update to server
            fetch("{{ url_for('publishing.toggle_automation') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    blog_id: blogId,
                    status: status
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Refresh page to show updated status
                    window.location.reload();
                } else {
                    alert('Error: ' + data.message);
                    // Revert toggle
                    this.checked = !status;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while updating automation status.');
                // Revert toggle
                this.checked = !status;
            });
        });
    }
});
</script>
{% endblock %}