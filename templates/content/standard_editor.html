{% extends 'base.html' %}

{% block title %}Standard Editor{% endblock %}

{% block styles %}
<style>
    .editor-container {
        min-height: 500px;
        margin-bottom: 20px;
    }
    
    .ck-editor__editable {
        min-height: 400px;
        color: #212529 !important;
    }
    
    .metadata-panel {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .seo-panel {
        background-color: rgba(40, 127, 113, 0.05);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .history-panel {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .autosave-info {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 5px;
    }
    
    .word-count {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 10px;
        text-align: right;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('content_creator.content_dashboard') }}">Content Creator</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Standard Editor</li>
                </ol>
            </nav>
            <h1 class="h2 mb-3">Standard Editor (WYSIWYG)</h1>
            <p class="text-muted">Create your content with a full-featured editor. Use the toolbar for formatting and structuring your content.</p>
        </div>
    </div>
    
    <form id="editor-form" method="post" action="{{ url_for('content_creator.edit_content', content_id=content_log.id if content_log else 0) }}">
        <div class="row">
            <div class="col-md-8">
                <!-- Editor Card -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Content Editor</h5>
                            <div class="autosave-info" id="autosave-status">
                                <small><i class="fas fa-save me-1"></i> Autosaving enabled</small>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="title" class="form-label">Title</label>
                            <input type="text" class="form-control" id="title" name="title" value="{{ content_log.title if content_log else '' }}" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editor" class="form-label">Content</label>
                            <div class="editor-container">
                                <textarea id="editor" name="content">{{ content_html|safe if content_html else '' }}</textarea>
                            </div>
                            <div class="word-count" id="word-count">
                                Words: 0
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- HTML/Markdown View -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0">HTML View</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <textarea class="form-control" id="html-view" rows="10" readonly></textarea>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <!-- Action Buttons -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0">Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button type="submit" name="action" value="save" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i> Save Draft
                            </button>
                            <button type="submit" name="action" value="publish" class="btn btn-success">
                                <i class="fas fa-paper-plane me-2"></i> Publish
                            </button>
                            <button type="button" id="preview-button" class="btn btn-secondary">
                                <i class="fas fa-eye me-2"></i> Preview
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Metadata Panel -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0">Metadata</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="meta-description" class="form-label">Meta Description</label>
                            <textarea class="form-control" id="meta-description" name="meta_description" rows="3">{{ meta_description if meta_description else '' }}</textarea>
                            <small class="form-text text-muted">Brief description for search engines (150-160 characters)</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="excerpt" class="form-label">Excerpt</label>
                            <textarea class="form-control" id="excerpt" name="excerpt" rows="3">{{ excerpt if excerpt else '' }}</textarea>
                            <small class="form-text text-muted">Short summary shown in article listings</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="tags" class="form-label">Tags</label>
                            <input type="text" class="form-control" id="tags" name="tags" value="{{ tags|join(', ') if tags else '' }}" placeholder="tag1, tag2, tag3">
                            <small class="form-text text-muted">Comma separated tags</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="featured-image" class="form-label">Featured Image URL</label>
                            <input type="text" class="form-control" id="featured-image" name="featured_image_url" value="{{ featured_image_url if featured_image_url else '' }}" placeholder="https://example.com/image.jpg">
                        </div>
                    </div>
                </div>
                
                <!-- SEO Panel -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0">SEO Analysis</h5>
                    </div>
                    <div class="card-body">
                        <div id="seo-results">
                            <p class="text-muted">SEO analysis will appear here as you type...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Version History -->
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0">Version History</h5>
                    </div>
                    <div class="card-body">
                        <div id="version-history">
                            <p class="text-muted">Content versions will be listed here...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Hidden fields for topic ID and other parameters -->
        <input type="hidden" name="topic_id" value="{{ topic.id if topic else '' }}">
    </form>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="preview-modal" tabindex="-1" aria-labelledby="preview-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="preview-modal-label">Content Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="preview-container">
                    <h1 id="preview-title"></h1>
                    <div id="preview-content"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.ckeditor.com/ckeditor5/36.0.1/classic/ckeditor.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize CKEditor
        let editor;
        ClassicEditor
            .create(document.querySelector('#editor'), {
                toolbar: ['heading', '|', 'bold', 'italic', 'link', 'bulletedList', 'numberedList', 'blockQuote', 'insertTable', 'undo', 'redo'],
                heading: {
                    options: [
                        { model: 'paragraph', title: 'Paragraph', class: 'ck-heading_paragraph' },
                        { model: 'heading2', view: 'h2', title: 'Heading 2', class: 'ck-heading_heading2' },
                        { model: 'heading3', view: 'h3', title: 'Heading 3', class: 'ck-heading_heading3' },
                        { model: 'heading4', view: 'h4', title: 'Heading 4', class: 'ck-heading_heading4' }
                    ]
                }
            })
            .then(newEditor => {
                editor = newEditor;
                
                // Update HTML view when editor content changes
                editor.model.document.on('change:data', () => {
                    document.getElementById('html-view').value = editor.getData();
                    updateWordCount(editor.getData());
                });
                
                // Initial HTML update
                document.getElementById('html-view').value = editor.getData();
                updateWordCount(editor.getData());
                
                // Setup autosave
                setupAutosave(editor);
            })
            .catch(error => {
                console.error(error);
            });
        
        // Preview Button
        document.getElementById('preview-button').addEventListener('click', function() {
            if (editor) {
                const title = document.getElementById('title').value;
                const content = editor.getData();
                
                document.getElementById('preview-title').textContent = title;
                document.getElementById('preview-content').innerHTML = content;
                
                const previewModal = new bootstrap.Modal(document.getElementById('preview-modal'));
                previewModal.show();
            }
        });
        
        // Update word count
        function updateWordCount(text) {
            // Remove HTML tags
            const plainText = text.replace(/<[^>]*>/g, ' ');
            // Count words
            const words = plainText.split(/\s+/).filter(word => word.length > 0);
            document.getElementById('word-count').textContent = `Words: ${words.length}`;
            
            // Basic SEO Analysis
            updateSeoAnalysis(plainText, words.length);
        }
        
        // Simple SEO Analysis
        function updateSeoAnalysis(text, wordCount) {
            const seoResults = document.getElementById('seo-results');
            const metaDescription = document.getElementById('meta-description').value;
            
            let seoHtml = '<h6 class="mb-3">Content Analysis</h6>';
            
            // Word count check
            if (wordCount < 300) {
                seoHtml += `<div class="mb-2"><span class="badge bg-danger me-2">Too Short</span> Word count: ${wordCount} (aim for 600+)</div>`;
            } else if (wordCount < 600) {
                seoHtml += `<div class="mb-2"><span class="badge bg-warning me-2">Short</span> Word count: ${wordCount} (aim for 600+)</div>`;
            } else {
                seoHtml += `<div class="mb-2"><span class="badge bg-success me-2">Good</span> Word count: ${wordCount}</div>`;
            }
            
            // Meta description check
            if (!metaDescription) {
                seoHtml += '<div class="mb-2"><span class="badge bg-danger me-2">Missing</span> Meta description</div>';
            } else if (metaDescription.length < 120) {
                seoHtml += `<div class="mb-2"><span class="badge bg-warning me-2">Short</span> Meta description: ${metaDescription.length} chars (aim for 150-160)</div>`;
            } else if (metaDescription.length > 160) {
                seoHtml += `<div class="mb-2"><span class="badge bg-warning me-2">Long</span> Meta description: ${metaDescription.length} chars (aim for 150-160)</div>`;
            } else {
                seoHtml += `<div class="mb-2"><span class="badge bg-success me-2">Good</span> Meta description: ${metaDescription.length} chars</div>`;
            }
            
            // Keyword analysis (simple)
            if (text.length > 0) {
                const words = text.toLowerCase().split(/\W+/).filter(word => word.length > 3);
                const wordFreq = {};
                
                words.forEach(word => {
                    wordFreq[word] = (wordFreq[word] || 0) + 1;
                });
                
                // Sort by frequency
                const sortedWords = Object.entries(wordFreq)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);
                
                seoHtml += '<div class="mt-3"><h6>Top Keywords</h6><ul class="list-unstyled">';
                sortedWords.forEach(([word, count]) => {
                    seoHtml += `<li><small>${word}: ${count} times</small></li>`;
                });
                seoHtml += '</ul></div>';
            }
            
            seoResults.innerHTML = seoHtml;
        }
        
        // Autosave functionality
        function setupAutosave(editor) {
            let lastAutoSave = new Date();
            const autoSaveInterval = 2 * 60 * 1000; // 2 minutes
            const autoSaveStatus = document.getElementById('autosave-status');
            
            setInterval(() => {
                const now = new Date();
                if (now - lastAutoSave > autoSaveInterval) {
                    // Perform autosave
                    autoSaveStatus.innerHTML = '<small><i class="fas fa-sync fa-spin me-1"></i> Autosaving...</small>';
                    
                    // Here we would normally save to the server
                    // For now, just simulate the save
                    setTimeout(() => {
                        lastAutoSave = new Date();
                        const timeString = lastAutoSave.toLocaleTimeString();
                        autoSaveStatus.innerHTML = `<small><i class="fas fa-check-circle me-1 text-success"></i> Last autosaved at ${timeString}</small>`;
                    }, 1000);
                }
            }, 10000); // Check every 10 seconds
        }
    });
</script>
{% endblock %}