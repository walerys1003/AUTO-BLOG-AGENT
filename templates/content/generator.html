{% extends 'base.html' %}

{% block title %}New Content Generator{% endblock %}

{% block styles %}
<style>
    .topic-card {
        cursor: pointer;
        transition: all 0.2s ease;
        border-left: 3px solid transparent;
    }
    
    .topic-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        border-left-color: var(--primary-color);
    }
    
    .topic-card.selected {
        border-left-color: var(--primary-color);
        background-color: rgba(40, 127, 113, 0.05);
    }
    
    .topic-score {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--primary-color);
    }
    
    .topic-meta {
        font-size: 0.85rem;
    }
    
    .loader-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 200px;
    }
    
    .generation-progress {
        margin-bottom: 20px;
    }
    
    #editor-container {
        display: none;
    }
    
    .preview-content {
        min-height: 300px;
        color: #212529 !important;
    }
    
    .spinner-border {
        width: 3rem;
        height: 3rem;
    }
    
    .filter-section {
        background-color: rgba(40, 127, 113, 0.05);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .generation-settings {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .paragraph-placeholder {
        background-color: #f8f9fa;
        border: 1px dashed #dee2e6;
        border-radius: 5px;
        padding: 20px;
        margin-bottom: 15px;
        min-height: 100px;
    }
    
    .paragraph-heading {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 10px;
        color: var(--primary-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('content_creator.content_dashboard') }}">Content Creator</a></li>
                    <li class="breadcrumb-item active" aria-current="page">New Generator</li>
                </ol>
            </nav>
            <h1 class="h2 mb-3">Dynamic Content Generator</h1>
            <p class="text-muted">Select a topic and watch as your article is generated in real-time, paragraph by paragraph.</p>
        </div>
    </div>
    
    <!-- Topic Selection Section -->
    <div id="topic-selection-container" class="mb-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Select a Topic</h5>
                    <div>
                        <div class="input-group">
                            <input type="text" id="topic-search" class="form-control" placeholder="Search topics...">
                            <button class="btn btn-outline-secondary" type="button" id="topic-filter-btn">
                                <i class="fas fa-filter"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Filter Section (Initially Hidden) -->
                <div class="filter-section mb-3" id="filter-section" style="display: none;">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="blog-filter" class="form-label">Filter by Blog</label>
                            <select class="form-select" id="blog-filter">
                                <option value="">All Blogs</option>
                                {% for blog in blogs %}
                                <option value="{{ blog.id }}">{{ blog.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="sort-option" class="form-label">Sort by</label>
                            <select class="form-select" id="sort-option">
                                <option value="score">Score (Highest First)</option>
                                <option value="date_asc">Date (Oldest First)</option>
                                <option value="date_desc">Date (Newest First)</option>
                                <option value="title">Title (A-Z)</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <button class="btn btn-primary" id="apply-filters">Apply Filters</button>
                            <button class="btn btn-outline-secondary" id="reset-filters">Reset</button>
                        </div>
                    </div>
                </div>
                
                <!-- Loader for Topics -->
                <div id="topics-loader" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading topics...</span>
                    </div>
                    <p class="mt-3">Loading available topics...</p>
                </div>
                
                <!-- Topics Grid -->
                <div class="row g-3" id="topics-grid" style="display: none;">
                    <!-- Topics will be populated here dynamically -->
                </div>
                
                <!-- No Topics Message -->
                <div id="no-topics-message" class="text-center py-5" style="display: none;">
                    <div class="mb-3">
                        <i class="fas fa-search fa-3x text-muted"></i>
                    </div>
                    <h4>No Topics Found</h4>
                    <p class="text-muted">
                        Try adjusting your search criteria or generate new topics.
                    </p>
                    <a href="{{ url_for('content_creator.content_dashboard') }}" class="btn btn-primary mt-3">
                        <i class="fas fa-lightbulb me-2"></i> Discover New Topics
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Generation Settings Section -->
    <div id="generation-settings" class="mb-4" style="display: none;">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0">Generation Settings</h5>
            </div>
            <div class="card-body">
                <form id="generation-form">
                    <input type="hidden" id="selected-topic-id" name="topic_id">
                    <input type="hidden" id="selected-topic-title" name="topic_title">
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="writing-style" class="form-label">Writing Style</label>
                            <select class="form-select" id="writing-style" name="style">
                                <option value="informative">Informative & Educational</option>
                                <option value="conversational">Conversational & Friendly</option>
                                <option value="professional">Professional & Technical</option>
                                <option value="storytelling">Storytelling & Narrative</option>
                                <option value="persuasive">Persuasive & Compelling</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="paragraph-count" class="form-label">Number of Paragraphs</label>
                            <select class="form-select" id="paragraph-count" name="paragraph_count">
                                <option value="3">3 paragraphs</option>
                                <option value="4" selected>4 paragraphs</option>
                                <option value="5">5 paragraphs</option>
                                <option value="6">6 paragraphs</option>
                                <option value="7">7 paragraphs</option>
                                <option value="8">8 paragraphs</option>
                            </select>
                            <small class="form-text text-muted">Each paragraph covers a distinct aspect of the topic</small>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <button type="button" id="generate-button" class="btn btn-success btn-lg w-100">
                            <i class="fas fa-magic me-2"></i> Generate Article
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Editor Container (Initially Hidden) -->
    <div id="editor-container" class="mb-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0" id="article-title">Article Title</h5>
                    <div class="btn-group">
                        <button type="button" id="save-draft-button" class="btn btn-outline-primary">
                            <i class="fas fa-save me-1"></i> Save Draft
                        </button>
                        <button type="button" id="edit-metadata-button" class="btn btn-outline-secondary">
                            <i class="fas fa-cog me-1"></i> Metadata
                        </button>
                        <button type="button" id="publish-button" class="btn btn-success">
                            <i class="fas fa-paper-plane me-1"></i> Publish
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Generation Progress -->
                <div class="generation-progress">
                    <div class="progress" style="height: 10px;">
                        <div id="generation-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                    <p class="text-center mt-2 mb-4" id="generation-status">Preparing to generate content...</p>
                </div>
                
                <!-- Article Content Preview -->
                <div class="preview-content p-4" id="article-content">
                    <!-- Dynamic content will be inserted here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Article Plan Template (Hidden) -->
<div id="article-plan-template" style="display: none;">
    <div class="paragraph-placeholder" data-index="{{index}}">
        <div class="paragraph-heading">{{title}}</div>
        <div class="placeholder-content">
            <div class="d-flex justify-content-center align-items-center" style="height: 60px;">
                <div class="spinner-border text-primary spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span>Generating content...</span>
            </div>
        </div>
    </div>
</div>

<!-- Topic Card Template (Hidden) -->
<div id="topic-card-template" style="display: none;">
    <div class="col-md-6 col-lg-4">
        <div class="card h-100 topic-card border-0 shadow-sm" data-topic-id="{{id}}" data-topic-title="{{title}}">
            <div class="card-body">
                <div class="d-flex mb-3">
                    <div class="flex-grow-1">
                        <h5 class="card-title mb-1 text-truncate">{{title}}</h5>
                        <div class="topic-meta text-muted">
                            <small>Blog: {{blog_name}}</small>
                        </div>
                    </div>
                    <div class="ms-3 text-center">
                        <div class="topic-score">{{score}}</div>
                        <small class="d-block text-muted">Score</small>
                    </div>
                </div>
                <div class="topic-keywords mb-2">
                    {{keywords}}
                </div>
                <div class="text-end mt-auto">
                    <small class="text-muted">{{created_at}}</small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // DOM Elements
        const topicSelectionContainer = document.getElementById('topic-selection-container');
        const generationSettings = document.getElementById('generation-settings');
        const editorContainer = document.getElementById('editor-container');
        const topicsGrid = document.getElementById('topics-grid');
        const topicsLoader = document.getElementById('topics-loader');
        const noTopicsMessage = document.getElementById('no-topics-message');
        const topicCardTemplate = document.getElementById('topic-card-template').innerHTML;
        const articlePlanTemplate = document.getElementById('article-plan-template').innerHTML;
        const topicFilterBtn = document.getElementById('topic-filter-btn');
        const filterSection = document.getElementById('filter-section');
        const topicSearch = document.getElementById('topic-search');
        const blogFilter = document.getElementById('blog-filter');
        const sortOption = document.getElementById('sort-option');
        const applyFiltersBtn = document.getElementById('apply-filters');
        const resetFiltersBtn = document.getElementById('reset-filters');
        const generateButton = document.getElementById('generate-button');
        const articleTitle = document.getElementById('article-title');
        const articleContent = document.getElementById('article-content');
        const generationProgressBar = document.getElementById('generation-progress-bar');
        const generationStatus = document.getElementById('generation-status');
        const selectedTopicId = document.getElementById('selected-topic-id');
        const selectedTopicTitle = document.getElementById('selected-topic-title');
        const writingStyle = document.getElementById('writing-style');
        const paragraphCount = document.getElementById('paragraph-count');
        const saveDraftButton = document.getElementById('save-draft-button');
        const editMetadataButton = document.getElementById('edit-metadata-button');
        const publishButton = document.getElementById('publish-button');
        
        // State Variables
        let topics = [];
        let filteredTopics = [];
        let selectedTopic = null;
        let articlePlan = null;
        let currentParagraphIndex = 0;
        let totalParagraphs = 0;
        let contentDraftId = null;
        
        // Toggle Filter Section
        topicFilterBtn.addEventListener('click', function() {
            filterSection.style.display = filterSection.style.display === 'none' ? 'block' : 'none';
        });
        
        // Fetch All Topics
        function fetchTopics(blogId = null) {
            topicsLoader.style.display = 'block';
            topicsGrid.style.display = 'none';
            noTopicsMessage.style.display = 'none';
            
            let url = '{{ url_for("content_creator.get_all_topics") }}';
            if (blogId) {
                url += `?blog_id=${blogId}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        topics = data.topics;
                        filteredTopics = [...topics];
                        renderTopics(filteredTopics);
                    } else {
                        console.error('Error fetching topics:', data.message);
                        showNoTopicsMessage();
                    }
                })
                .catch(error => {
                    console.error('Error fetching topics:', error);
                    showNoTopicsMessage();
                })
                .finally(() => {
                    topicsLoader.style.display = 'none';
                });
        }
        
        // Render Topics to Grid
        function renderTopics(topicsToRender) {
            topicsGrid.innerHTML = '';
            
            if (topicsToRender.length === 0) {
                showNoTopicsMessage();
                return;
            }
            
            topicsToRender.forEach(topic => {
                const keywordsHtml = topic.keywords ? 
                    topic.keywords.split(',').map(k => `<span class="badge bg-light text-dark me-1">${k.trim()}</span>`).join('') : '';
                
                let html = topicCardTemplate
                    .replace(/{{id}}/g, topic.id)
                    .replace(/{{title}}/g, topic.title)
                    .replace(/{{blog_name}}/g, topic.blog_name || 'Unknown Blog')
                    .replace(/{{score}}/g, topic.score.toFixed(1))
                    .replace(/{{keywords}}/g, keywordsHtml)
                    .replace(/{{created_at}}/g, topic.created_at || 'Unknown Date');
                
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                topicsGrid.appendChild(tempDiv.firstElementChild);
            });
            
            // Add event listener to topic cards
            document.querySelectorAll('.topic-card').forEach(card => {
                card.addEventListener('click', handleTopicSelection);
            });
            
            topicsGrid.style.display = 'flex';
        }
        
        // Show No Topics Message
        function showNoTopicsMessage() {
            topicsGrid.style.display = 'none';
            noTopicsMessage.style.display = 'block';
        }
        
        // Handle Topic Selection
        function handleTopicSelection(event) {
            const card = event.currentTarget;
            
            // Remove selection from all cards
            document.querySelectorAll('.topic-card').forEach(c => {
                c.classList.remove('selected');
            });
            
            // Add selection to clicked card
            card.classList.add('selected');
            
            // Update selected topic
            selectedTopic = {
                id: card.dataset.topicId,
                title: card.dataset.topicTitle
            };
            
            // Show generation settings
            selectedTopicId.value = selectedTopic.id;
            selectedTopicTitle.value = selectedTopic.title;
            generationSettings.style.display = 'block';
            
            // Scroll to generation settings
            generationSettings.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Filter Topics
        function filterTopics() {
            const searchTerm = topicSearch.value.toLowerCase();
            const blogId = blogFilter.value;
            const sortBy = sortOption.value;
            
            let filtered = [...topics];
            
            // Apply search filter
            if (searchTerm) {
                filtered = filtered.filter(topic => 
                    topic.title.toLowerCase().includes(searchTerm)
                );
            }
            
            // Apply blog filter
            if (blogId) {
                filtered = filtered.filter(topic => topic.blog_id.toString() === blogId);
            }
            
            // Apply sorting
            switch(sortBy) {
                case 'score':
                    filtered.sort((a, b) => b.score - a.score);
                    break;
                case 'date_asc':
                    filtered.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                    break;
                case 'date_desc':
                    filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    break;
                case 'title':
                    filtered.sort((a, b) => a.title.localeCompare(b.title));
                    break;
            }
            
            filteredTopics = filtered;
            renderTopics(filteredTopics);
        }
        
        // Handle Generate Button Click
        generateButton.addEventListener('click', function() {
            if (!selectedTopic) {
                alert('Please select a topic first.');
                return;
            }
            
            // Show editor container and hide other sections
            topicSelectionContainer.style.display = 'none';
            generationSettings.style.display = 'none';
            editorContainer.style.display = 'block';
            
            // Set article title
            articleTitle.textContent = selectedTopic.title;
            
            // Clear previous content
            articleContent.innerHTML = '';
            
            // Reset progress
            generationProgressBar.style.width = '0%';
            generationStatus.textContent = 'Generating article plan...';
            
            // Get the selected options
            const style = writingStyle.value;
            const paragraphCountValue = parseInt(paragraphCount.value);
            
            // Create draft content entry
            createDraftContent(selectedTopic.title, selectedTopic.id)
                .then(draftId => {
                    contentDraftId = draftId;
                    // Generate article plan
                    return generateArticlePlan(selectedTopic.title, paragraphCountValue, style);
                })
                .then(plan => {
                    articlePlan = plan;
                    totalParagraphs = plan.length;
                    currentParagraphIndex = 0;
                    
                    // Create placeholders for each paragraph
                    articleContent.innerHTML = '';
                    plan.forEach((paragraph, index) => {
                        const placeholderHtml = articlePlanTemplate
                            .replace(/{{index}}/g, index)
                            .replace(/{{title}}/g, paragraph.title);
                        
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = placeholderHtml;
                        articleContent.appendChild(tempDiv.firstElementChild);
                    });
                    
                    // Update progress
                    updateGenerationProgress(0, totalParagraphs);
                    
                    // Start generating paragraphs
                    return generateNextParagraph();
                })
                .catch(error => {
                    console.error('Error:', error);
                    generationStatus.textContent = 'Error generating content. Please try again.';
                    generationStatus.classList.add('text-danger');
                });
        });
        
        // Create Draft Content Entry
        function createDraftContent(title, topicId) {
            return fetch('{{ url_for("content_creator.api_create_draft_content_v2") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'title': title,
                    'topic_id': topicId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    return data.content_id;
                } else {
                    throw new Error(data.message || 'Failed to create draft content');
                }
            });
        }
        
        // Generate Article Plan
        function generateArticlePlan(topic, paragraphCount, style) {
            return fetch('{{ url_for("content_creator.generate_article_plan_api") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'topic': topic,
                    'paragraph_count': paragraphCount,
                    'style': style
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    return data.plan;
                } else {
                    throw new Error(data.message || 'Failed to generate article plan');
                }
            });
        }
        
        // Generate Next Paragraph
        function generateNextParagraph() {
            if (currentParagraphIndex >= totalParagraphs) {
                // All paragraphs generated
                generationStatus.textContent = 'Article generation complete!';
                generationProgressBar.style.width = '100%';
                saveDraftButton.disabled = false;
                editMetadataButton.disabled = false;
                publishButton.disabled = false;
                return Promise.resolve();
            }
            
            const paragraphData = articlePlan[currentParagraphIndex];
            const isIntroduction = currentParagraphIndex === 0;
            const isConclusion = currentParagraphIndex === totalParagraphs - 1;
            
            updateGenerationProgress(currentParagraphIndex, totalParagraphs);
            
            return fetch('{{ url_for("content_creator.generate_dynamic_paragraph") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'topic': selectedTopic.title,
                    'paragraph_topic': paragraphData.title,
                    'style': writingStyle.value,
                    'paragraph_index': currentParagraphIndex,
                    'total_paragraphs': totalParagraphs,
                    'content_id': contentDraftId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the placeholder with the generated content
                    const placeholder = document.querySelector(`.paragraph-placeholder[data-index="${currentParagraphIndex}"]`);
                    if (placeholder) {
                        placeholder.querySelector('.placeholder-content').innerHTML = `<div class="paragraph-content">${data.content}</div>`;
                    }
                    
                    // Move to next paragraph
                    currentParagraphIndex++;
                    updateGenerationProgress(currentParagraphIndex, totalParagraphs);
                    
                    // Generate next paragraph
                    return generateNextParagraph();
                } else {
                    throw new Error(data.message || 'Failed to generate paragraph');
                }
            });
        }
        
        // Update Generation Progress
        function updateGenerationProgress(current, total) {
            const progress = (current / total) * 100;
            generationProgressBar.style.width = `${progress}%`;
            
            if (current < total) {
                generationStatus.textContent = `Generating paragraph ${current + 1} of ${total}...`;
            } else {
                generationStatus.textContent = 'Article generation complete!';
            }
        }
        
        // Save Draft Button
        saveDraftButton.addEventListener('click', function() {
            if (!contentDraftId) return;
            
            // Redirect to edit page
            window.location.href = '{{ url_for("content_creator.edit_content", content_id=0) }}'.replace('/edit/0/', '/edit/' + contentDraftId + '/');
        });
        
        // Edit Metadata Button
        editMetadataButton.addEventListener('click', function() {
            if (!contentDraftId) return;
            
            // Show metadata modal (to be implemented)
            alert('Metadata editing will be implemented soon.');
        });
        
        // Publish Button
        publishButton.addEventListener('click', function() {
            if (!contentDraftId) return;
            
            // Redirect to publish page
            window.location.href = '{{ url_for("content_creator.publish_content", content_id=0) }}'.replace('/publish/0/', '/publish/' + contentDraftId + '/');
        });
        
        // Search Input Event
        topicSearch.addEventListener('input', debounce(function() {
            filterTopics();
        }, 300));
        
        // Apply Filters
        applyFiltersBtn.addEventListener('click', function() {
            filterTopics();
            filterSection.style.display = 'none';
        });
        
        // Reset Filters
        resetFiltersBtn.addEventListener('click', function() {
            topicSearch.value = '';
            blogFilter.value = '';
            sortOption.value = 'score';
            filteredTopics = [...topics];
            renderTopics(filteredTopics);
        });
        
        // Debounce Function
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    func.apply(context, args);
                }, wait);
            };
        }
        
        // Initialize
        fetchTopics();
        
        // Disable buttons until article is generated
        saveDraftButton.disabled = true;
        editMetadataButton.disabled = true;
        publishButton.disabled = true;
    });
</script>
{% endblock %}