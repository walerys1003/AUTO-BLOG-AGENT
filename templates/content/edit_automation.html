{% extends 'base.html' %}

{% block title %}{% if rule %}Edit{% else %}New{% endif %} Automation Rule - BLOG AUTOMATION MASTER{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1 class="h2 mb-0">
            <i class="fas fa-robot text-secondary me-2"></i>
            {% if rule %}Edit{% else %}New{% endif %} Automation Rule
        </h1>
        <p class="text-muted mt-2">
            {% if rule %}Modify{% else %}Configure{% endif %} settings for automatic content creation and publishing.
        </p>
    </div>
    <div class="col-md-4 text-end">
        <a href="{{ url_for('content_creator.automation_dashboard') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i> Back to Automation
        </a>
    </div>
</div>

<div class="card border-0 shadow-sm mb-4">
    <div class="card-body p-4">
        <form method="post" action="">
            <div class="row mb-4">
                <div class="col-md-12">
                    <h4 class="mb-3">Basic Settings</h4>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="name" class="form-label">Rule Name</label>
                            <input type="text" class="form-control" id="name" name="name" 
                                   value="{{ rule.name if rule else '' }}" required>
                            <div class="form-text">Give your automation rule a descriptive name</div>
                        </div>
                        <div class="col-md-6">
                            <label for="blog_id" class="form-label">Blog</label>
                            <select class="form-select" id="blog_id" name="blog_id" required>
                                <option value="">Select a blog</option>
                                {% for blog in blogs %}
                                <option value="{{ blog.id }}" 
                                        {% if rule and rule.blog_id == blog.id %}selected{% endif %}>
                                    {{ blog.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Select which blog this rule will create content for</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-12">
                    <h4 class="mb-3">Content Generation Settings</h4>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="writing_style" class="form-label">Writing Style</label>
                            <select class="form-select" id="writing_style" name="writing_style">
                                <option value="informative" 
                                        {% if rule and rule.content_tone == 'informative' %}selected{% endif %}>
                                    Informative & Educational
                                </option>
                                <option value="conversational" 
                                        {% if rule and rule.content_tone == 'conversational' %}selected{% endif %}>
                                    Conversational & Friendly
                                </option>
                                <option value="professional" 
                                        {% if rule and rule.content_tone == 'professional' %}selected{% endif %}>
                                    Professional & Technical
                                </option>
                                <option value="storytelling" 
                                        {% if rule and rule.content_tone == 'storytelling' %}selected{% endif %}>
                                    Storytelling & Narrative
                                </option>
                                <option value="persuasive" 
                                        {% if rule and rule.content_tone == 'persuasive' %}selected{% endif %}>
                                    Persuasive & Compelling
                                </option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="use_paragraph_mode" 
                                       name="use_paragraph_mode" 
                                       {% if rule and rule.use_paragraph_mode %}checked{% endif %}
                                       onchange="toggleContentMode(this.checked)">
                                <label class="form-check-label" for="use_paragraph_mode">
                                    <strong>Use Paragraph-Based Generation</strong>
                                </label>
                                <div class="form-text">
                                    Generate articles based on a fixed number of paragraphs instead of word count
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row g-3 mt-2">
                        <!-- Word count mode options -->
                        <div class="col-md-6" id="word_count_options" style="{% if rule and rule.use_paragraph_mode %}display: none;{% endif %}">
                            <label for="content_length" class="form-label">Content Length</label>
                            <select class="form-select" id="content_length" name="content_length">
                                <option value="short" 
                                        {% if rule and rule.content_length == 'short' %}selected{% endif %}>
                                    Short (~800 words)
                                </option>
                                <option value="medium" 
                                        {% if rule and rule.content_length == 'medium' %}selected{% endif %}>
                                    Medium (~1200 words)
                                </option>
                                <option value="long" 
                                        {% if rule and rule.content_length == 'long' %}selected{% endif %}>
                                    Long (~1600 words)
                                </option>
                            </select>
                            <div class="form-text">Select the approximate length of generated articles</div>
                        </div>
                        
                        <!-- Paragraph mode options -->
                        <div class="col-md-6" id="paragraph_options" style="{% if not rule or not rule.use_paragraph_mode %}display: none;{% endif %}">
                            <label for="paragraph_count" class="form-label">Number of Paragraphs</label>
                            <select class="form-select" id="paragraph_count" name="paragraph_count">
                                <option value="3" {% if rule and rule.paragraph_count == 3 %}selected{% endif %}>
                                    3 paragraphs (short article)
                                </option>
                                <option value="4" {% if not rule or rule.paragraph_count == 4 %}selected{% endif %}>
                                    4 paragraphs (recommended)
                                </option>
                                <option value="5" {% if rule and rule.paragraph_count == 5 %}selected{% endif %}>
                                    5 paragraphs (medium article)
                                </option>
                                <option value="6" {% if rule and rule.paragraph_count == 6 %}selected{% endif %}>
                                    6 paragraphs (long article)
                                </option>
                            </select>
                            <div class="form-text">
                                Each paragraph will focus on a distinct aspect of the topic, plus introduction and conclusion
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-12">
                    <h4 class="mb-3">Publishing Settings</h4>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Publishing Days</label>
                            <div class="form-text mb-2">Select which days of the week to publish content</div>
                            
                            {% set days = rule.get_publishing_days() if rule else [0, 1, 2, 3, 4, 5, 6] %}
                            <div class="btn-group d-flex flex-wrap" role="group">
                                <div class="form-check form-switch ms-2 mb-2">
                                    <input class="form-check-input" type="checkbox" id="day0" name="publishing_days" value="0"
                                           {% if 0 in days %}checked{% endif %}>
                                    <label class="form-check-label" for="day0">Monday</label>
                                </div>
                                <div class="form-check form-switch ms-2 mb-2">
                                    <input class="form-check-input" type="checkbox" id="day1" name="publishing_days" value="1"
                                           {% if 1 in days %}checked{% endif %}>
                                    <label class="form-check-label" for="day1">Tuesday</label>
                                </div>
                                <div class="form-check form-switch ms-2 mb-2">
                                    <input class="form-check-input" type="checkbox" id="day2" name="publishing_days" value="2"
                                           {% if 2 in days %}checked{% endif %}>
                                    <label class="form-check-label" for="day2">Wednesday</label>
                                </div>
                                <div class="form-check form-switch ms-2 mb-2">
                                    <input class="form-check-input" type="checkbox" id="day3" name="publishing_days" value="3"
                                           {% if 3 in days %}checked{% endif %}>
                                    <label class="form-check-label" for="day3">Thursday</label>
                                </div>
                                <div class="form-check form-switch ms-2 mb-2">
                                    <input class="form-check-input" type="checkbox" id="day4" name="publishing_days" value="4"
                                           {% if 4 in days %}checked{% endif %}>
                                    <label class="form-check-label" for="day4">Friday</label>
                                </div>
                                <div class="form-check form-switch ms-2 mb-2">
                                    <input class="form-check-input" type="checkbox" id="day5" name="publishing_days" value="5"
                                           {% if 5 in days %}checked{% endif %}>
                                    <label class="form-check-label" for="day5">Saturday</label>
                                </div>
                                <div class="form-check form-switch ms-2 mb-2">
                                    <input class="form-check-input" type="checkbox" id="day6" name="publishing_days" value="6"
                                           {% if 6 in days %}checked{% endif %}>
                                    <label class="form-check-label" for="day6">Sunday</label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="publishing_time" class="form-label">Publishing Time</label>
                                    <input type="time" class="form-control" id="publishing_time" name="publishing_time"
                                           value="{{ rule.publishing_time if rule else '12:00' }}">
                                    <div class="form-text">Time of day to publish (24-hour format)</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="posts_per_day" class="form-label">Posts Per Day</label>
                                    <input type="number" class="form-control" id="posts_per_day" name="posts_per_day" 
                                           min="1" max="10" value="{{ rule.posts_per_day if rule else 1 }}">
                                    <div class="form-text">Number of posts to publish each day</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-12">
                    <h4 class="mb-3">Topic Selection Criteria</h4>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="topic_min_score" class="form-label">Minimum Topic Score</label>
                            <input type="range" class="form-range" id="topic_min_score" name="topic_min_score" 
                                   min="0" max="1" step="0.1" value="{{ rule.topic_min_score if rule else 0.7 }}"
                                   oninput="updateScoreValue(this.value)">
                            <div class="d-flex justify-content-between">
                                <span>Low Quality (0.0)</span>
                                <span id="scoreValue">{{ rule.topic_min_score if rule else 0.7 }}</span>
                                <span>High Quality (1.0)</span>
                            </div>
                            <div class="form-text">Only use topics with a score at or above this threshold</div>
                        </div>
                        <div class="col-md-6">
                            <label for="categories" class="form-label">Categories</label>
                            <select class="form-select" id="categories" name="categories" multiple size="5">
                                {% if selected_blog %}
                                {% for category in selected_blog.get_categories() %}
                                <option value="{{ category }}" 
                                        {% if rule and category in rule.get_categories() %}selected{% endif %}>
                                    {{ category }}
                                </option>
                                {% endfor %}
                                {% else %}
                                <option value="" disabled>Select a blog first to see categories</option>
                                {% endif %}
                            </select>
                            <div class="form-text">Leave empty to use all categories or select specific ones</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-12">
                    <h4 class="mb-3">Auto-scheduling Settings</h4>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="auto_enable_topics" name="auto_enable_topics" 
                                       {% if rule and rule.auto_enable_topics %}checked{% endif %}>
                                <label class="form-check-label" for="auto_enable_topics">
                                    Auto-approve topics that meet quality criteria
                                </label>
                            </div>
                            <div class="form-text ms-4">
                                Automatically approve topics that meet the minimum score without manual review
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="auto_promote_content" name="auto_promote_content" 
                                       {% if not rule or rule.auto_promote_content %}checked{% endif %}>
                                <label class="form-check-label" for="auto_promote_content">
                                    Auto-promote content to social media
                                </label>
                            </div>
                            <div class="form-text ms-4">
                                Automatically post newly published content to connected social media accounts
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12 text-end">
                    <a href="{{ url_for('content_creator.automation_dashboard') }}" class="btn btn-secondary me-2">Cancel</a>
                    <button type="submit" class="btn btn-primary">
                        {% if rule %}Update{% else %}Create{% endif %} Automation Rule
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function updateScoreValue(value) {
        document.getElementById('scoreValue').textContent = value;
    }
    
    // Toggle between word count and paragraph based modes
    function toggleContentMode(useParagraphMode) {
        const wordCountOptions = document.getElementById('word_count_options');
        const paragraphOptions = document.getElementById('paragraph_options');
        
        if (useParagraphMode) {
            wordCountOptions.style.display = 'none';
            paragraphOptions.style.display = 'block';
        } else {
            wordCountOptions.style.display = 'block';
            paragraphOptions.style.display = 'none';
        }
    }
    
    // When blog selection changes, load categories for that blog
    document.getElementById('blog_id').addEventListener('change', function() {
        const blogId = this.value;
        if (!blogId) return;
        
        console.log(`Loading categories for blog ID: ${blogId}`);
        
        // Show loading indicator
        const categoriesSelect = document.getElementById('categories');
        categoriesSelect.innerHTML = '<option value="">Loading categories...</option>';
        
        fetch(`/api/blogs/${blogId}/categories`)
            .then(response => {
                console.log('Categories API response:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Categories data:', data);
                categoriesSelect.innerHTML = '';
                
                if (data.success && data.categories && data.categories.length > 0) {
                    data.categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        option.textContent = category.name;
                        categoriesSelect.appendChild(option);
                    });
                } else {
                    categoriesSelect.innerHTML = '<option value="">No categories found</option>';
                }
            })
            .catch(error => {
                console.error('Error loading categories:', error);
                categoriesSelect.innerHTML = '<option value="">Error loading categories</option>';
            });
    });
    
    // Initialize the content mode toggle
    document.addEventListener('DOMContentLoaded', function() {
        const useParagraphMode = document.getElementById('use_paragraph_mode').checked;
        toggleContentMode(useParagraphMode);
    });
</script>
{% endblock %}