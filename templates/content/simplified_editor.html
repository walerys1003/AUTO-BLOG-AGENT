{% extends 'base.html' %}

{% block title %}Content Editor{% endblock %}

{% block styles %}
<style>
    .editor-container {
        min-height: 400px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('simplified_content.content_creator') }}">Content Creator</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ 'Edit Content' if content else 'New Content' }}</li>
                </ol>
            </nav>
            <h1 class="h2 mb-3">{{ 'Edit Content' if content else 'New Content' }}</h1>
            <p class="text-muted">
                {% if topic %}
                Creating content for topic: <strong>{{ topic.title }}</strong>
                {% else %}
                Create or edit content for your blog.
                {% endif %}
            </p>
        </div>
    </div>
    
    <div class="card border-0 shadow-sm">
        <div class="card-body p-4">
            <form method="POST" action="{{ url_for('simplified_content.content_editor', content_id=content.id if content else None) }}">
                <!-- Blog Selection -->
                <div class="mb-3">
                    <label for="blog_id" class="form-label">Blog</label>
                    <select class="form-select" id="blog_id" name="blog_id" required>
                        {% for blog in blogs %}
                            <option value="{{ blog.id }}" {% if (content and content.blog_id == blog.id) or (blog_id and blog_id|int == blog.id) or (topic and topic.blog_id == blog.id) %}selected{% endif %}>
                                {{ blog.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Title -->
                <div class="mb-3">
                    <label for="title" class="form-label">Title</label>
                    <input type="text" class="form-control" id="title" name="title" value="{{ content.title if content else (topic.title if topic else '') }}" required>
                </div>
                
                <!-- Hidden Topic Field -->
                {% if topic %}
                <input type="hidden" name="topic" value="{{ topic.title }}">
                {% endif %}
                
                <!-- AI Content Generation Options -->
                <div class="card mb-4 border-0 shadow-sm bg-light">
                    <div class="card-body">
                        <h5 class="card-title mb-3">
                            <i class="fas fa-robot me-2"></i> AI Content Generation
                        </h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="writing_style" class="form-label">Writing Style</label>
                                <select class="form-select" id="writing_style">
                                    <option value="professional" selected>Professional</option>
                                    <option value="conversational">Conversational</option>
                                    <option value="persuasive">Persuasive</option>
                                    <option value="educational">Educational</option>
                                    <option value="creative">Creative</option>
                                    <option value="humorous">Humorous</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="paragraphs" class="form-label">Number of Paragraphs</label>
                                <select class="form-select" id="paragraphs">
                                    <option value="3">3 paragraphs (Short)</option>
                                    <option value="5" selected>5 paragraphs (Medium)</option>
                                    <option value="8">8 paragraphs (Long)</option>
                                    <option value="12">12 paragraphs (Very Long)</option>
                                </select>
                            </div>
                        </div>
                        <div class="text-end mt-3">
                            <button type="button" id="generate_content" class="btn btn-primary">
                                <i class="fas fa-magic me-2"></i> Generate with AI
                            </button>
                        </div>
                        <div id="generation_status" class="mt-3 d-none">
                            <div class="d-flex align-items-center">
                                <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <span>Generating content... This may take up to 30 seconds for high-quality articles.</span>
                            </div>
                        </div>
                        <div id="generation_error" class="mt-3 alert alert-danger d-none"></div>
                    </div>
                </div>
                
                <!-- Content Editor -->
                <div class="mb-4">
                    <label for="body" class="form-label">Content</label>
                    <div class="editor-container">
                        <textarea class="form-control" id="body" name="body" rows="15">{{ content.body if content else '' }}</textarea>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="d-flex justify-content-between">
                    <a href="{{ url_for('simplified_content.content_creator') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i> Back
                    </a>
                    
                    <div>
                        <button type="submit" name="action" value="save" class="btn btn-primary me-2">
                            <i class="fas fa-save me-2"></i> Save Draft
                        </button>
                        
                        <button type="submit" name="action" value="publish" class="btn btn-success">
                            <i class="fas fa-paper-plane me-2"></i> Publish
                        </button>
                    </div>
                </div>
                
                {% if content %}
                <!-- Delete Button (for existing content) -->
                <hr class="my-4">
                <div class="text-end">
                    <form method="POST" action="{{ url_for('simplified_content.delete_content', content_id=content.id) }}" class="d-inline">
                        <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this content?')">
                            <i class="fas fa-trash me-2"></i> Delete Content
                        </button>
                    </form>
                </div>
                {% endif %}
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.ckeditor.com/ckeditor5/36.0.1/classic/ckeditor.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize CKEditor
        let editor;
        
        ClassicEditor
            .create(document.querySelector('#body'))
            .then(newEditor => {
                editor = newEditor;
            })
            .catch(error => {
                console.error('Error initializing editor:', error);
            });
        
        // AI Content Generation
        const generateButton = document.getElementById('generate_content');
        const generationStatus = document.getElementById('generation_status');
        const generationError = document.getElementById('generation_error');
        const titleInput = document.getElementById('title');
        const styleSelect = document.getElementById('writing_style');
        const paragraphsSelect = document.getElementById('paragraphs');
        
        generateButton.addEventListener('click', function() {
            // Get values
            const title = titleInput.value.trim();
            const style = styleSelect.value;
            const paragraphs = paragraphsSelect.value;
            
            // Validate title
            if (!title) {
                generationError.textContent = 'Please enter a title for your content.';
                generationError.classList.remove('d-none');
                return;
            }
            
            // Hide error message if previously shown
            generationError.classList.add('d-none');
            
            // Show loading indicator
            generationStatus.classList.remove('d-none');
            generateButton.disabled = true;
            
            // Make API call to generate content
            fetch('{{ url_for("simplified_content.generate_content") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'title': title,
                    'style': style,
                    'paragraphs': paragraphs
                })
            })
            .then(response => response.json())
            .then(data => {
                // Hide loading indicator
                generationStatus.classList.add('d-none');
                generateButton.disabled = false;
                
                if (data.success) {
                    // Set content in editor
                    if (editor) {
                        editor.setData(data.content);
                    }
                } else {
                    // Show error
                    generationError.textContent = data.error || 'An error occurred while generating content.';
                    generationError.classList.remove('d-none');
                }
            })
            .catch(error => {
                // Hide loading indicator
                generationStatus.classList.add('d-none');
                generateButton.disabled = false;
                
                // Show error
                generationError.textContent = 'Network error: ' + error.message;
                generationError.classList.remove('d-none');
                console.error('Error:', error);
            });
        });
    });
</script>
{% endblock %}