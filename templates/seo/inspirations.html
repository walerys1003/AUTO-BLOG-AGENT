{% extends 'base.html' %}

{% block title %}SEO Inspirations - BLOG AUTOMATION MASTER{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-lg-8">
        <h1 class="h2 mb-0">
            <i class="fas fa-lightbulb text-warning me-2"></i> SEO Inspirations
        </h1>
        <p class="text-muted mt-2">
            Review and manage AI-generated topic suggestions based on SEO trends and search data.
        </p>
    </div>
    <div class="col-lg-4 text-end">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#generateTopicsModal">
            <i class="fas fa-sync-alt me-2"></i> Generate Topics
        </button>
        <button type="button" class="btn btn-outline-primary ms-2" data-bs-toggle="modal" data-bs-target="#addManualTopicModal">
            <i class="fas fa-plus me-2"></i> Add Manual Topic
        </button>
    </div>
</div>

<!-- Filter Controls -->
<div class="card mb-4 border-0 shadow-sm">
    <div class="card-body bg-light">
        <div class="row align-items-center">
            <div class="col-md-6">
                <div class="d-flex">
                    <div class="btn-group me-3">
                        <a href="{{ url_for('seo_inspiration.seo_inspirations', status='pending', blog_id=active_blog) }}" 
                           class="btn {% if active_status == 'pending' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                            Pending
                        </a>
                        <a href="{{ url_for('seo_inspiration.seo_inspirations', status='approved', blog_id=active_blog) }}" 
                           class="btn {% if active_status == 'approved' %}btn-success{% else %}btn-outline-success{% endif %}">
                            Approved
                        </a>
                        <a href="{{ url_for('seo_inspiration.seo_inspirations', status='rejected', blog_id=active_blog) }}" 
                           class="btn {% if active_status == 'rejected' %}btn-danger{% else %}btn-outline-danger{% endif %}">
                            Rejected
                        </a>
                        <a href="{{ url_for('seo_inspiration.seo_inspirations', status='used', blog_id=active_blog) }}" 
                           class="btn {% if active_status == 'used' %}btn-secondary{% else %}btn-outline-secondary{% endif %}">
                            Used
                        </a>
                        <a href="{{ url_for('seo_inspiration.seo_inspirations', status='all', blog_id=active_blog) }}" 
                           class="btn {% if active_status == 'all' %}btn-dark{% else %}btn-outline-dark{% endif %}">
                            All
                        </a>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="d-flex justify-content-md-end mt-3 mt-md-0">
                    <div class="form-group">
                        <select class="form-select" id="blogFilter" onchange="filterByBlog(this.value)">
                            <option value="">All Blogs</option>
                            {% for blog in blogs %}
                            <option value="{{ blog.id }}" {% if active_blog == blog.id %}selected{% endif %}>{{ blog.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Topics List -->
<div class="card border-0 shadow-sm">
    <div class="card-header bg-white py-3">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h5 class="mb-0">Topic Suggestions</h5>
            </div>
            <div class="col-md-6 text-md-end">
                <small class="text-muted">Showing {{ topics|length }} topics</small>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        {% if topics %}
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th style="width: 40%">Title</th>
                        <th style="width: 15%">Blog</th>
                        <th style="width: 15%">Category</th>
                        <th style="width: 10%">Date</th>
                        <th style="width: 10%">Status</th>
                        <th style="width: 10%" class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for topic in topics %}
                    <tr id="topic-row-{{ topic.id }}">
                        <td>
                            <div class="d-flex align-items-center">
                                <div>
                                    <div class="fw-bold topic-title-{{ topic.id }}">{{ topic.title }}</div>
                                    <div class="small text-muted topic-keywords-{{ topic.id }}">
                                        {% if topic.get_keywords() %}
                                            {% for keyword in topic.get_keywords() %}
                                            <span class="badge bg-light text-dark me-1 keyword-tag" 
                                                  data-bs-toggle="tooltip" 
                                                  title="Click to analyze" 
                                                  onclick="analyzeKeyword('{{ keyword }}')">{{ keyword }}</span>
                                            {% endfor %}
                                        {% else %}
                                            <span class="fst-italic">No keywords</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td>{{ topic.blog.name }}</td>
                        <td class="topic-category-{{ topic.id }}">
                            {% if topic.category %}
                                {{ topic.category }}
                            {% else %}
                                <span class="fst-italic text-muted">Uncategorized</span>
                            {% endif %}
                        </td>
                        <td><small>{{ topic.created_at.strftime('%Y-%m-%d') }}</small></td>
                        <td>
                            <span class="badge bg-{{ 
                                'primary' if topic.status == 'pending' else 
                                'success' if topic.status == 'approved' else 
                                'danger' if topic.status == 'rejected' else 
                                'secondary' if topic.status == 'used' else 'primary' 
                            }} topic-status-badge-{{ topic.id }}">
                                {{ topic.status|capitalize }}
                            </span>
                        </td>
                        <td class="text-end">
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <!-- Status Options -->
                                    <li><h6 class="dropdown-header">Change Status</h6></li>
                                    <li>
                                        <button class="dropdown-item status-action" 
                                                data-topic-id="{{ topic.id }}" 
                                                data-status="pending"
                                                {% if topic.status == 'pending' %}disabled{% endif %}>
                                            <i class="fas fa-clock text-primary me-2"></i> Mark as Pending
                                        </button>
                                    </li>
                                    <li>
                                        <button class="dropdown-item status-action" 
                                                data-topic-id="{{ topic.id }}" 
                                                data-status="approved"
                                                {% if topic.status == 'approved' %}disabled{% endif %}>
                                            <i class="fas fa-check text-success me-2"></i> Approve
                                        </button>
                                    </li>
                                    <li>
                                        <button class="dropdown-item status-action" 
                                                data-topic-id="{{ topic.id }}" 
                                                data-status="rejected"
                                                {% if topic.status == 'rejected' %}disabled{% endif %}>
                                            <i class="fas fa-times text-danger me-2"></i> Reject
                                        </button>
                                    </li>
                                    <li>
                                        <button class="dropdown-item status-action" 
                                                data-topic-id="{{ topic.id }}" 
                                                data-status="used"
                                                {% if topic.status == 'used' %}disabled{% endif %}>
                                            <i class="fas fa-check-double text-secondary me-2"></i> Mark as Used
                                        </button>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <!-- Actions -->
                                    <li>
                                        <button class="dropdown-item" 
                                                onclick="editTopic('{{ topic.id }}', '{{ topic.title }}', '{{ topic.get_keywords()|join(', ') }}', '{{ topic.category }}')">
                                            <i class="fas fa-edit text-info me-2"></i> Edit
                                        </button>
                                    </li>
                                    <li>
                                        <form action="{{ url_for('seo_inspiration.delete_topic', topic_id=topic.id) }}" method="post"
                                              onsubmit="return confirm('Are you sure you want to delete this topic?');">
                                            <button type="submit" class="dropdown-item text-danger">
                                                <i class="fas fa-trash-alt me-2"></i> Delete
                                            </button>
                                        </form>
                                    </li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <div class="mb-3">
                <i class="fas fa-search fa-3x text-muted"></i>
            </div>
            <h4>No topics found</h4>
            <p class="text-muted">
                {% if active_status != 'all' %}
                No topics with '{{ active_status }}' status{% if active_blog %} for the selected blog{% endif %}.
                {% else %}
                No topics found{% if active_blog %} for the selected blog{% endif %}.
                {% endif %}
            </p>
            <button type="button" class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#generateTopicsModal">
                <i class="fas fa-sync-alt me-2"></i> Generate Topics
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Generate Topics Modal -->
<div class="modal fade" id="generateTopicsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Generate SEO Topic Suggestions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('seo_inspiration.generate_inspirations') }}" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="blog_id" class="form-label">Blog</label>
                        <select class="form-select" id="blog_id" name="blog_id">
                            <option value="">All Blogs</option>
                            {% for blog in blogs %}
                            <option value="{{ blog.id }}">{{ blog.name }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Select a specific blog or generate for all blogs.</div>
                    </div>
                    <div class="mb-3">
                        <label for="count" class="form-label">Number of Suggestions</label>
                        <select class="form-select" id="count" name="count">
                            <option value="1">1 topic</option>
                            <option value="3" selected>3 topics</option>
                            <option value="5">5 topics</option>
                            <option value="10">10 topics</option>
                        </select>
                        <div class="form-text">Number of topics to generate per blog.</div>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Topic generation uses SEO trends and keyword analysis to suggest relevant content ideas. This process may take a moment.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-sync-alt me-2"></i> Generate Topics
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Manual Topic Modal -->
<div class="modal fade" id="addManualTopicModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Manual Topic</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('seo_inspiration.add_manual_topic') }}" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="manual_blog_id" class="form-label">Blog</label>
                        <select class="form-select" id="manual_blog_id" name="blog_id" required>
                            <option value="">Select a Blog</option>
                            {% for blog in blogs %}
                            <option value="{{ blog.id }}">{{ blog.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="title" class="form-label">Topic Title</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="keywords" class="form-label">Keywords (comma separated)</label>
                        <input type="text" class="form-control" id="keywords" name="keywords" placeholder="e.g. seo, digital marketing, content">
                    </div>
                    <div class="mb-3">
                        <label for="category" class="form-label">Category</label>
                        <input type="text" class="form-control" id="category" name="category" placeholder="e.g. Marketing">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Topic</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Topic Modal -->
<div class="modal fade" id="editTopicModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Topic</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit_topic_id">
                <div class="mb-3">
                    <label for="edit_title" class="form-label">Topic Title</label>
                    <input type="text" class="form-control" id="edit_title" required>
                </div>
                <div class="mb-3">
                    <label for="edit_keywords" class="form-label">Keywords (comma separated)</label>
                    <input type="text" class="form-control" id="edit_keywords" placeholder="e.g. seo, digital marketing, content">
                </div>
                <div class="mb-3">
                    <label for="edit_category" class="form-label">Category</label>
                    <input type="text" class="form-control" id="edit_category" placeholder="e.g. Marketing">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveTopic()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Keyword Analysis Modal -->
<div class="modal fade" id="keywordAnalysisModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Keyword Analysis</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="keyword-loading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Analyzing keyword data...</p>
                </div>
                <div id="keyword-results" class="d-none">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card h-100 border-primary">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="card-title mb-0" id="keyword-title">Keyword</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <span class="fw-bold">Monthly Search Volume: </span>
                                        <span id="search-volume">-</span>
                                    </div>
                                    <div class="mb-3">
                                        <span class="fw-bold">Keyword Difficulty: </span>
                                        <div class="progress mt-1">
                                            <div id="keyword-difficulty-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                        </div>
                                        <small class="text-muted mt-1 d-block" id="difficulty-label">-</small>
                                    </div>
                                    <div class="mb-3">
                                        <span class="fw-bold">Trend: </span>
                                        <span id="keyword-trend">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-dark text-white">
                                    <h5 class="card-title mb-0">SEO Potential</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <span class="fw-bold">Opportunity Score: </span>
                                        <div class="d-inline-block ms-2">
                                            <span id="opportunity-score">-</span>/10
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <span class="fw-bold">CPC (Estimated): </span>
                                        <span id="keyword-cpc">-</span>
                                    </div>
                                    <div>
                                        <span class="fw-bold">Recommendation: </span>
                                        <span id="keyword-recommendation" class="fst-italic">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="card-title mb-0">Related Keywords</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table mb-0">
                                    <thead>
                                        <tr>
                                            <th>Keyword</th>
                                            <th>Search Volume</th>
                                            <th>Difficulty</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="related-keywords-list">
                                        <!-- Filled by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="keyword-error" class="alert alert-danger d-none">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <span id="error-message">An error occurred while analyzing the keyword.</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Filter by blog
function filterByBlog(blogId) {
    const url = new URL(window.location);
    url.searchParams.set('blog_id', blogId);
    window.location.href = url.toString();
}

// Update topic status
document.querySelectorAll('.status-action').forEach(button => {
    button.addEventListener('click', function() {
        const topicId = this.dataset.topicId;
        const newStatus = this.dataset.status;
        
        // Send AJAX request to update status
        fetch("{{ url_for('seo_inspiration.update_topic_status') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `topic_id=${topicId}&status=${newStatus}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update badge
                const badge = document.querySelector(`.topic-status-badge-${topicId}`);
                badge.className = `badge bg-${
                    newStatus === 'pending' ? 'primary' : 
                    newStatus === 'approved' ? 'success' : 
                    newStatus === 'rejected' ? 'danger' : 
                    'secondary'
                } topic-status-badge-${topicId}`;
                badge.textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
                
                // Update dropdown buttons
                const dropdown = document.querySelectorAll(`button[data-topic-id="${topicId}"]`);
                dropdown.forEach(btn => {
                    btn.disabled = btn.dataset.status === newStatus;
                });
                
                // Show toast or flash message
                showToast('Success', 'Topic status updated successfully', 'success');
            } else {
                showToast('Error', data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error', 'Failed to update topic status', 'danger');
        });
    });
});

// Edit topic function
function editTopic(id, title, keywords, category) {
    document.getElementById('edit_topic_id').value = id;
    document.getElementById('edit_title').value = title;
    document.getElementById('edit_keywords').value = keywords;
    document.getElementById('edit_category').value = category;
    
    // Show the modal
    new bootstrap.Modal(document.getElementById('editTopicModal')).show();
}

// Save topic changes
function saveTopic() {
    const topicId = document.getElementById('edit_topic_id').value;
    const title = document.getElementById('edit_title').value;
    const keywords = document.getElementById('edit_keywords').value;
    const category = document.getElementById('edit_category').value;
    
    // Form validation
    if (!title) {
        alert('Title is required');
        return;
    }
    
    // Send AJAX request to update topic
    fetch("{{ url_for('seo_inspiration.edit_topic') }}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `topic_id=${topicId}&title=${encodeURIComponent(title)}&keywords=${encodeURIComponent(keywords)}&category=${encodeURIComponent(category)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the UI
            document.querySelector(`.topic-title-${topicId}`).textContent = title;
            
            // Update keywords display
            const keywordsContainer = document.querySelector(`.topic-keywords-${topicId}`);
            if (keywords && keywords.length > 0) {
                const keywordArray = keywords.split(',').map(k => k.trim());
                let keywordsHtml = '';
                keywordArray.forEach(keyword => {
                    keywordsHtml += `<span class="badge bg-light text-dark me-1 keyword-tag" data-bs-toggle="tooltip" title="Click to analyze" onclick="analyzeKeyword('${keyword}')">${keyword}</span>`;
                });
                keywordsContainer.innerHTML = keywordsHtml;
            } else {
                keywordsContainer.innerHTML = '<span class="fst-italic">No keywords</span>';
            }
            
            // Update category
            const categoryContainer = document.querySelector(`.topic-category-${topicId}`);
            if (category) {
                categoryContainer.textContent = category;
            } else {
                categoryContainer.innerHTML = '<span class="fst-italic text-muted">Uncategorized</span>';
            }
            
            // Close the modal
            bootstrap.Modal.getInstance(document.getElementById('editTopicModal')).hide();
            
            // Show success message
            showToast('Success', 'Topic updated successfully', 'success');
        } else {
            showToast('Error', data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error', 'Failed to update topic', 'danger');
    });
}

// Analyze keyword
function analyzeKeyword(keyword) {
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('keywordAnalysisModal'));
    modal.show();
    
    // Show loading state, hide results and error
    document.getElementById('keyword-loading').classList.remove('d-none');
    document.getElementById('keyword-results').classList.add('d-none');
    document.getElementById('keyword-error').classList.add('d-none');
    
    // Set the keyword title
    document.getElementById('keyword-title').textContent = keyword;
    
    // Send AJAX request to analyze keyword
    fetch("{{ url_for('seo_inspiration.analyze_keyword') }}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `keyword=${encodeURIComponent(keyword)}`
    })
    .then(response => response.json())
    .then(data => {
        // Hide loading
        document.getElementById('keyword-loading').classList.add('d-none');
        
        if (data.success) {
            // Show results
            document.getElementById('keyword-results').classList.remove('d-none');
            
            // Fill in the data
            const keywordData = data.data;
            
            // Volume
            document.getElementById('search-volume').textContent = keywordData.volume ? numberWithCommas(keywordData.volume) + ' searches/month' : 'Data not available';
            
            // Difficulty
            const difficultyValue = keywordData.difficulty || 0;
            const difficultyBar = document.getElementById('keyword-difficulty-bar');
            difficultyBar.style.width = `${difficultyValue}%`;
            
            // Set color based on difficulty
            if (difficultyValue < 30) {
                difficultyBar.className = 'progress-bar bg-success';
                document.getElementById('difficulty-label').textContent = 'Easy';
            } else if (difficultyValue < 60) {
                difficultyBar.className = 'progress-bar bg-warning';
                document.getElementById('difficulty-label').textContent = 'Moderate';
            } else {
                difficultyBar.className = 'progress-bar bg-danger';
                document.getElementById('difficulty-label').textContent = 'Difficult';
            }
            
            // Trend
            const trendElement = document.getElementById('keyword-trend');
            if (keywordData.trend) {
                const trendDirection = keywordData.trend > 0 ? 'Increasing' : keywordData.trend < 0 ? 'Decreasing' : 'Stable';
                const trendIcon = keywordData.trend > 0 ? '<i class="fas fa-arrow-up text-success"></i>' : 
                                 keywordData.trend < 0 ? '<i class="fas fa-arrow-down text-danger"></i>' : 
                                 '<i class="fas fa-minus text-secondary"></i>';
                
                trendElement.innerHTML = `${trendIcon} ${trendDirection}`;
            } else {
                trendElement.textContent = 'Data not available';
            }
            
            // Opportunity score
            const opportunityScore = keywordData.opportunity || 'N/A';
            document.getElementById('opportunity-score').textContent = opportunityScore;
            
            // CPC
            document.getElementById('keyword-cpc').textContent = keywordData.cpc ? '$' + keywordData.cpc.toFixed(2) : 'Data not available';
            
            // Recommendation
            document.getElementById('keyword-recommendation').textContent = keywordData.recommendation || 'No specific recommendation available';
            
            // Related keywords
            const relatedKeywordsList = document.getElementById('related-keywords-list');
            relatedKeywordsList.innerHTML = '';
            
            if (keywordData.related && keywordData.related.length > 0) {
                keywordData.related.forEach(related => {
                    relatedKeywordsList.innerHTML += `
                    <tr>
                        <td>${related.keyword}</td>
                        <td>${related.volume ? numberWithCommas(related.volume) : 'N/A'}</td>
                        <td>
                            <div class="progress" style="height: 5px;">
                                <div class="progress-bar ${getDifficultyClass(related.difficulty || 0)}" 
                                     style="width: ${related.difficulty || 0}%"></div>
                            </div>
                            <small>${getDifficultyLabel(related.difficulty || 0)}</small>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" 
                                    onclick="analyzeKeyword('${related.keyword}')">
                                Analyze
                            </button>
                        </td>
                    </tr>
                    `;
                });
            } else {
                relatedKeywordsList.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center py-3">No related keywords available</td>
                </tr>
                `;
            }
        } else {
            // Show error
            document.getElementById('keyword-error').classList.remove('d-none');
            document.getElementById('error-message').textContent = data.message || 'An error occurred while analyzing the keyword';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Hide loading and show error
        document.getElementById('keyword-loading').classList.add('d-none');
        document.getElementById('keyword-error').classList.remove('d-none');
        document.getElementById('error-message').textContent = 'Failed to analyze keyword';
    });
}

// Helper function to format numbers with commas
function numberWithCommas(x) {
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

// Helper function to get difficulty class
function getDifficultyClass(value) {
    if (value < 30) return 'bg-success';
    if (value < 60) return 'bg-warning';
    return 'bg-danger';
}

// Helper function to get difficulty label
function getDifficultyLabel(value) {
    if (value < 30) return 'Easy';
    if (value < 60) return 'Moderate';
    return 'Difficult';
}

// Toast notification
function showToast(title, message, type = 'info') {
    // Create toast container if it doesn't exist
    let toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(toastContainer);
    }
    
    // Create toast element
    const toastId = 'toast-' + Date.now();
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.id = toastId;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    
    // Toast content
    toast.innerHTML = `
    <div class="d-flex">
        <div class="toast-body">
            <strong>${title}</strong>: ${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    `;
    
    // Add to container
    toastContainer.appendChild(toast);
    
    // Initialize and show toast
    const toastInstance = new bootstrap.Toast(toast, {
        autohide: true,
        delay: 5000
    });
    toastInstance.show();
    
    // Remove from DOM after hidden
    toast.addEventListener('hidden.bs.toast', function () {
        toast.remove();
    });
}

// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });
});
</script>
{% endblock %}